name: Automated MLOps Deploy

on:
  push:
    branches: [ "main" ] # Chạy khi có code mới vào nhánh main
    pull_request:
    branches: [ "main" ]

jobs:

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Quan trọng để quét toàn bộ history

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Nếu phát hiện secret, pipeline sẽ fail ngay lập tức

  # JOB 2: Quét Dependencies & Code Vulnerabilities (SCA & SAST)
  # Sử dụng Trivy - công cụ All-in-one rất mạnh mẽ
  security-scan:
    runs-on: ubuntu-latest
    needs: secret-scan # Chỉ chạy nếu scan secret thành công
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # Quét file system
          ignore-unfixed: true
          format: 'table'
          exit-code: '1' # Fail pipeline nếu phát hiện lỗi High/Critical
          severity: 'CRITICAL,HIGH'

  # JOB 3: (Tùy chọn) Code Quality & Security sâu hơn với SonarCloud
  # Cần tạo tài khoản SonarCloud và lấy Token
  # code-quality:
  #   runs-on: ubuntu-latest
  #   needs: security-scan
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
      
      # Chỉ chạy nếu bạn đã setup SonarCloud
      # - name: SonarCloud Scan
      #   uses: SonarSource/sonarcloud-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
